# Мини-CRM распределения лидов

Система для автоматического распределения обращений лидов между операторами с учетом весов и лимитов нагрузки.

## Запуск проекта

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите сервер:
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

3. Откройте документацию API: http://localhost:8000/docs

## Модель данных

### Основные сущности:

- **Operator** - оператор:
  - `is_active` - активен/не активен
  - `max_load` - максимальная нагрузка (количество активных обращений)
  - `current_load` - текущая нагрузка

- **Lead** - лид (клиент):
  - `external_id` - внешний идентификатор
  - `email` - email
  - `phone` - телефон

- **Source** - источник (бот)
- **OperatorSourceWeight** - вес оператора для источника
- **Contact** - обращение лида

## Алгоритм распределения

### Идентификация лида
Лид определяется по приоритету:
1. `external_id` (внешний идентификатор)
2. `email` 
3. `phone`

Если лид не найден - создается новый.

### Распределение по операторам

1. **Доступные операторы**: выбираются операторы, которые:
   - Активны (`is_active = True`)
   - Не превысили лимит нагрузки (`current_load < max_load`)
   - Имеют вес для данного источника

2. **Взвешенный выбор**: используется вероятностный алгоритм:
   - Вероятность выбора оператора = `вес_оператора / сумма_всех_весов`
   - Используется случайный выбор с учетом весов

3. **Обработка перегрузки**: если выбранный оператор превысил лимит, система пытается выбрать другого.

### Если операторы не найдены
Обращение создается без назначенного оператора (`operator_id = null`).

## API эндпоинты

- `POST /operators/` - создание оператора
- `GET /operators/` - список операторов
- `PUT /operators/{id}` - обновление оператора
- `POST /sources/` - создание источника
- `GET /sources/` - список источников
- `POST /distribution/config/` - настройка распределения
- `POST /contacts/` - создание обращения (запускает распределение)
- `GET /contacts/` - список обращений
- `GET /leads/` - список лидов
```

## Запуск проекта

1. Создайте виртуальное окружение и установите зависимости:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows

pip install -r requirements.txt
```

2. Запустите сервер:
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

3. Откройте http://localhost:8000/docs для работы с API через Swagger UI.